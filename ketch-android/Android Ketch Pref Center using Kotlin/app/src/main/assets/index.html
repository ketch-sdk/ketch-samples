<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script>
            // Get query parameters
            let params = (new URL(document.location)).searchParams;

            // Get property name from query parameters
            let propertyName = params.get("propertyName");
            // Get organization code from query parameters
            let orgCode = params.get("orgCode");

            // Get identities from query string
            let encodedIdentities = params.get("encodedIdentities")
            let decodedIdentities = atob(encodedIdentities)

            // Add identities to dataLayer
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push(decodedIdentities);

            var e=document.createElement("script");
            e.type="text/javascript";
            e.src=`https://global.ketchcdn.com/web/v1/config/${orgCode}/${propertyName}/boot.js`;
            e.defer=e.async=!0;
            document.getElementsByTagName("head")[0].appendChild(e);
            window.semaphore=window.semaphore||[];
        </script>

        <script>
            // Show the preference center experience
            window.semaphore.push(['showPreferences'])

            // Custom plugin to listen for the closing of the preference center experience
            var custom_plugin = {
                'init': function(host) {
                    console.log('pluginInitialized');
                    androidListener.pluginInitialized();
                },
                'experienceHidden': function(host, config, reason) {
                    console.log('experienceHidden, reason = ' + reason);
                    if ((reason.constructor.name === 'String' && reason === 'setConsent') || reason.constructor.name === 'PointerEvent') {
                        androidListener.experienceHidden();
                    }
                },
                'consentChanged': function(host, config, consent) {
                    console.log('consentChanged, consent: ' + JSON.stringify(consent));
                    androidListener.consentChanged(JSON.stringify(consent));
                }
            }

            // Register the custom plugin with the Ketch Smart Tag
            window.semaphore = window.semaphore || [];
            window.semaphore.push(['registerPlugin', custom_plugin]);
        </script>
    </head>
    <body>
    </body>
</html>
